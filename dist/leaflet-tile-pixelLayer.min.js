"use strict";!function(){function m(t){return null!=t}function a(t,i){var a=t[0],e=t[1],r=t[2],n=i[0]-a,o=i[1]-e,l=i[2]-r;return function(t,i){return[Math.floor(a+t*n),Math.floor(e+t*o),Math.floor(r+t*l),i]}}function l(t,i,a){return(function(t,i){return Math.max(i[0],Math.min(t,i[1]))}(t,[i,a])-i)/(a-i)}L.TilePixelLayer=L.TileLayer.extend({options:{data:null,overlayAlpha:230,gap:2,zIndex:7,gradient:[]},map:null,builder:null,grid:null,gridDataBuilt:null,date:null,replaceNaN:!0,replaceNaNValue:0,"λ0":null,"φ0":null,"Δλ":null,"Δφ":null,ni:null,nj:null,initialize:function(t){L.setOptions(this,t),this.gradient=function(t){for(var r=[],n=[],o=[],i=0;i<t.length-1;i++)r.push(t[i+1][0]),n.push(a(t[i][1],t[i+1][1])),o.push([t[i][0],t[i+1][0]]);return function(t,i){for(var a=0;a<r.length-1&&!(t<=r[a]);a++);var e=o[a];return n[a](l(t,e[0],e[1]),i)}}(t.gradient)},createTile:function(t){var i=L.DomUtil.create("canvas","leafvar-pixel-tile"),a=this.getTileSize();i.width=a.x,i.height=a.y;var e=i.getContext("2d"),r={x:t.x*i.width,y:t.y*i.height,z:t.z,w:i.width,h:i.height};return this.interpolateField(e,r),i},onAdd:function(i){var n=this,o=this;this.map=i,function(t){var i=t.url,c=t.data;return new Promise(function(h){i||h(c);var s=c.min,d=new Image;d.src=i,d.onload=function(){var t=document.createElement("canvas");t.width=d.width,t.height=d.height;var i=t.getContext("2d");i.drawImage(d,0,0);for(var a=i.getImageData(0,0,d.width,d.height),e=[],r=0;r<a.data.length;r+=4){var n=a.data[r].toString(),o=a.data[r+1].toString(),l=a.data[r+2].toString(),u=Number(n+o+l)-Math.abs(s);e.push(u)}h([{header:c,data:e}])}})}(this.options).then(function(t){n.buildGrid(t),n.map.on("click",function(t){var i=t.latlng,a=i.lat,e=i.lng,r=o.gridDataBuilt.interpolate(e,a);n.options.clickEvt&&n.options.clickEvt(t,r)}),L.TileLayer.prototype.onAdd.call(n,i)})},onRemove:function(t){this.gridDataBuilt=null,L.TileLayer.prototype.onRemove.call(this,t)},createBuilder:function(i){return{header:i.header,data:function(t){return i.data[t]},interpolate:this.bilinearInterpolateScalar}},buildGrid:function(t){var f=this;this.builder=this.createBuilder(t[0]);var i=this.builder.header;this.λ0=i.lo1,this.φ0=i.la1,this.Δλ=i.dx,this.Δφ=i.dy,this.ni=i.nx,this.nj=i.ny,this.date=new Date(i.refTime),this.date.setHours(this.date.getHours()+i.forecastTime),this.grid=[];for(var a=0,e=0;e<this.nj;e++){for(var r=[],n=0;n<this.ni;n++,a++)r[n]=this.builder.data(a),this.replaceNaN&&isNaN(r[n])&&(r[n]=this.replaceNaNValue);r.push(r[0]),this.grid[e]=r}f.gridDataBuilt={date:this.date,interpolate:function(t,i){if(!f.grid)return null;var a,e=function(t,i){return t-i*Math.floor(t/i)}(t-f.λ0,360)/f.Δλ,r=(f.φ0-i)/f.Δφ,n=Math.floor(e),o=n+1,l=Math.floor(r),u=l+1;if(a=f.grid[l]){var h=a[n],s=a[o];if(m(h)&&m(s)&&(a=f.grid[u])){var d=a[n],c=a[o];if(m(d)&&m(c))return f.builder.interpolate(e-n,r-l,h,s,d,c)}}return null}}},pointToCoord:function(t,i,a){var e=this.map.unproject(L.point(t,i),a);return[e.lng,e.lat]},createMask:function(t,i){if(!t)return null;var r=i.w,a=i.h;t.fillStyle="rgba(255, 255, 255, 0.1)",t.fill();var e=t.getImageData(0,0,r,a),n=e.data;return{imageData:e,set:function(t,i,a){var e=4*(i*r+t);return n[e]=a[0],n[1+e]=a[1],n[2+e]=a[2],n[3+e]=a[3],this}}},bilinearInterpolateScalar:function(t,i,a,e,r,n){var o=1-t,l=1-i;return a*o*l+e*t*l+r*o*i+n*t*i},interpolateField:function(a,c){var f=this,e=c.x,r=0,t=this.options.gap;(!Number.isInteger(this.options.gap)||this.options.gap<1)&&(console.warn("Option Gap Must be interger and greater than 0!"),t=2);var g=this.map.getZoom()<=4&&2<t?2:t,p=g;console.log(g);var v=this.createMask(a,c);function n(t,i){for(var a=[0,0,0,1],e=c.y,r=0;r<=c.h;e+=p,r+=p){var n=a,o=f.pointToCoord(t,e,c.z);if(o){var l=o[0],u=o[1];if(isFinite(l)){var h=f.gridDataBuilt.interpolate(l,u);m(h)&&(n=f.gradient(h,f.options.overlayAlpha))}}for(var s=0;s<g;s++)for(var d=0;d<p;d++)v.set(i+s,r+d,n)}}!function t(){for(var i=Date.now();r<c.w;)if(n(e,r),e+=g,r+=g,500<Date.now()-i)return void setTimeout(t,25);a.putImageData(v.imageData,0,0)}()}}),L.tilePixelLayer=function(t){return new L.TilePixelLayer(t)}}();